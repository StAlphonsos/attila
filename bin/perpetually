#!/bin/sh
##
# perpetually - do something perpetually and timestamp the output into a log
#
# I use this command:
#    $ perpetually finfo --log=$HOME/logs/finance.log
# to start up my finance watching log.
##
argval () {
    _opt="$1"
    shift
    echo "$*" | sed -e "s/^--${_opt}=//"
}

sleep=300
cmd=""
msg=""

while [ x"$1" != x ]; do
    case "$1" in
        --sleep=*)
	    _sleep=`argval sleep "$1"`
	    echo $0: sleep: $sleep '=>' $_sleep
	    sleep=$_sleep
	    ;;
	--msg=*)
	    msg=`argval msg "$1"`
	    ;;
	--log=*)
	    log=`argval log "$1"`
	    ;;
	*)
	    if [ x"$cmd" = x ]; then
		cmd="$1"
	    else
		cmd="${cmd} $1"
	    fi
	    ;;
    esac
    shift
done
[ x"$cmd" = x ] && {
    echo $0: no command given, msg=$msg
    exit 1
}
[ x"$msg" = x ] && {
    msg="Running: $cmd"
}
[ x"$log" = x ] && {
    _name=`echo ${cmd} | awk '{print $1}'`
    log=`basename ${_name}`.log
    echo $0: logging to ${log}
}
exec 2>&1
while true; do
    echo '*** '$msg
    ${cmd}
    echo '*** All quiet'
    sleep ${sleep}
done | ts -days ${log}
